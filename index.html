<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å››å­£ç‰©èª - å…¨çƒç‰ˆ</title>
    <style>
        :root {
            --spring: #4CAF50; --summer: #FFD700; --autumn: #FF9800; --winter: #2196F3;
            --bg: #0f0f12; --panel: rgba(42, 42, 46, 0.95);
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: white; margin: 0; padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom); overflow: hidden; height: 100vh; }
        
        /* å‹•ç•«æ•ˆæœ */
        @keyframes roll { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }
        @keyframes shine { 0% { box-shadow: 0 0 5px #fff; } 50% { box-shadow: 0 0 20px #fff; } 100% { box-shadow: 0 0 5px #fff; } }
        .rolling { animation: roll 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* é ‚éƒ¨å°èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 10px 15px; border-radius: 20px; border-bottom: 2px solid #444; margin-bottom: 10px; }
        .crystal-box { font-size: 1.5rem; color: #4fc3f7; font-weight: bold; text-shadow: 0 0 10px rgba(79,195,247,0.5); }

        /* è³‡æºæ¬„èˆ‡å­£ç¯€ */
        .res-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .res-item { background: #222; padding: 12px 5px; border-radius: 12px; text-align: center; border: 2px solid transparent; font-size: 1.1rem; position: relative; }
        .active-rate { border-color: white; animation: shine 2s infinite; }

        #season-wheel { 
            text-align: center; padding: 12px; border-radius: 50px; font-weight: bold; 
            margin-bottom: 15px; transition: 0.8s; border: 1px solid rgba(255,255,255,0.2);
        }

        /* éª°å­å±•ç¤ºå€ */
        .dice-area { height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .dice-view { width: 60px; height: 60px; background: white; border-radius: 10px; color: #333; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* å¡ç‰Œç®¡ç† */
        .section-label { font-size: 0.75rem; color: #888; margin-left: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .scroll-row { display: flex; overflow-x: auto; gap: 12px; padding: 10px 5px; -webkit-overflow-scrolling: touch; }
        .card { 
            min-width: 120px; height: 160px; background: linear-gradient(135deg, #fff, #ddd); color: #333; 
            padding: 8px; border-radius: 12px; flex-shrink: 0; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); transition: 0.3s;
        }
        .card.passive { border: 3px solid #9c27b0; }
        .card b { font-size: 0.85rem; display: block; height: 2.5em; overflow: hidden; }
        .card-cost { font-size: 0.7rem; color: #666; margin: 5px 0; }
        
        /* çµç®—ç•«é¢ */
        #end-screen { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px;
        }
        .score-row { display: flex; justify-content: space-between; width: 100%; margin: 10px 0; font-size: 1.2rem; }

        .btn { border: none; border-radius: 12px; font-weight: bold; color: white; transition: 0.2s; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #e91e63, #9c27b0); width: 100%; padding: 15px; font-size: 1.1rem; }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="header">
        <div class="crystal-box">ğŸ’ <span id="crystal">0</span></div>
        <div style="text-align: right;">
            <div id="year-display" style="font-size: 0.8rem; color: #aaa;">YEAR 1 / 3</div>
            <div id="summon-limit" style="font-weight: bold;">â­ 0 / 1</div>
        </div>
    </div>

    <div class="res-grid">
        <div class="res-item" id="r-water" onclick="game.transmute('water')">ğŸ’§ <span id="water">0</span></div>
        <div class="res-item" id="r-fire" onclick="game.transmute('fire')">ğŸ”¥ <span id="fire">0</span></div>
        <div class="res-item" id="r-wind" onclick="game.transmute('wind')">ğŸƒ <span id="wind">0</span></div>
        <div class="res-item" id="r-earth" onclick="game.transmute('earth')">ğŸª¨ <span id="earth">0</span></div>
    </div>

    <div id="season-wheel">æ˜¥å­£ (ç¬¬ 1 æœˆ)</div>

    <div class="dice-area">
        <div id="dice-result" class="dice-view">ğŸ²</div>
    </div>

    <button class="btn btn-primary" id="roll-btn" onclick="game.roll()">å•Ÿå‹•å‘½é‹ä¹‹éª°</button>

    <div class="section-label" style="margin-top:15px;">å’’èªæ›¸ (ç•¶å‰æ‰‹ç‰Œ)</div>
    <div class="scroll-row" id="hand-list"></div>

    <div class="section-label">é­”æ³•å·¥åŠ (å·²å¬å–š)</div>
    <div class="scroll-row" id="field-list"></div>

    <div id="end-screen">
        <h1 style="color: #FFD700;">ç«¶è³½çµæŸ</h1>
        <div class="score-row"><span>æ°´æ™¶è³‡ç”¢</span><span id="s-crystal">0</span></div>
        <div class="score-row"><span>å¡ç‰Œå‹åˆ†</span><span id="s-cards">0</span></div>
        <div class="score-row" style="color:#ff5252;"><span>æ‰‹ç‰Œæ‡²ç½°</span><span id="s-pen">0</span></div>
        <hr style="width:100%; border:1px solid #444;">
        <div class="score-row" style="font-size: 2rem;"><span>ç¸½å¾—åˆ†</span><span id="s-total">0</span></div>
        <button class="btn btn-primary" style="margin-top:30px;" onclick="location.reload()">é‡æ–°é–‹å±€</button>
    </div>

<script>
/**
 * æ ¸å¿ƒå¼•æ“ï¼šSeasons Master Engine
 * å¯¦ä½œè¦å‰‡ï¼šå­£ç¯€è½‰åŒ–ã€è¢«å‹•è§¸ç™¼ã€åˆ†å¹´æ‰‹ç‰Œã€çµ‚å±€æ‡²ç½°ã€LocalStorage
 */
const game = {
    state: {
        year: 1, month: 0, crystals: 0,
        water: 0, fire: 0, earth: 0, wind: 0,
        summonMax: 1, currentSummon: 0,
        hand: [[], [], []], // 0:Year1, 1:Year2, 2:Year3
        field: []
    },

    cards: [
        { id: 1, name: "æµ·æ¸¯æ°´å¦–", icon: "ğŸ§œâ€â™€ï¸", cost: {water:1}, vp: 6, type: 'instant', action: () => game.state.crystals += 6 },
        { id: 2, name: "æ°¸æ†ç†”çˆ", icon: "âš’ï¸", cost: {fire:2}, vp: 8, type: 'passive', trigger: 'transmute', action: () => game.state.crystals += 2 },
        { id: 3, name: "æ³°å¦ç¥åƒ", icon: "ğŸ—¿", cost: {earth:3}, vp: 25, type: 'instant', action: () => {} },
        { id: 4, name: "æ™‚å…‰ç¥­å¸", icon: "â³", cost: {wind:2}, vp: 10, type: 'passive', trigger: 'newMonth', action: () => game.state.crystals += 1 },
        { id: 5, name: "å¤§æ°£æ ¸å¿ƒ", icon: "ğŸŒ€", cost: {wind:1, water:1}, vp: 12, type: 'instant', action: () => game.state.summonMax += 1 }
    ],

    seasons: [
        { name: 'æ˜¥å­£', color: 'var(--spring)', rates: {water:3, wind:2, fire:1, earth:1}, dice: ['ğŸ’§', 'ğŸ’§', 'ğŸƒ', 'â­', 'ğŸ’'] },
        { name: 'å¤å­£', color: 'var(--summer)', rates: {fire:3, earth:2, water:1, wind:1}, dice: ['ğŸ”¥', 'ğŸ”¥', 'ğŸª¨', 'â­', 'ğŸ’'] },
        { name: 'ç§‹å­£', color: 'var(--autumn)', rates: {wind:3, fire:2, water:1, earth:1}, dice: ['ğŸƒ', 'ğŸƒ', 'ğŸ”¥', 'â­', 'ğŸ’'] },
        { name: 'å†¬å­£', color: 'var(--winter)', rates: {earth:3, water:2, fire:1, wind:1}, dice: ['ğŸª¨', 'ğŸª¨', 'ğŸ’§', 'â­', 'ğŸ’'] }
    ],

    init() {
        const saved = localStorage.getItem('seasons_99_save');
        if (saved) {
            this.state = JSON.parse(saved);
        } else {
            // åˆæ¬¡é€²å…¥ï¼šéš¨æ©Ÿåˆ†é… 9 å¼µç‰Œ
            for(let y=0; y<3; y++) {
                for(let i=0; i<3; i++) {
                    const randomCard = this.cards[Math.floor(Math.random()*this.cards.length)];
                    this.state.hand[y].push({...randomCard, uuid: Math.random()});
                }
            }
        }
        this.updateUI();
    },

    updateUI() {
        const sIdx = Math.floor(this.state.month / 3);
        const s = this.seasons[sIdx];
        
        // å­£ç¯€èˆ‡æ¨™é¡Œ
        document.getElementById('season-wheel').innerText = `${s.name} (ç¬¬ ${this.state.month + 1} æœˆ)`;
        document.getElementById('season-wheel').style.backgroundColor = s.color;
        document.getElementById('year-display').innerText = `YEAR ${this.state.year} / 3`;
        document.getElementById('crystal').innerText = this.state.crystals;
        document.getElementById('summon-limit').innerText = `â­ ${this.state.currentSummon} / ${this.state.summonMax}`;

        // è³‡æºåŒ¯ç‡é«˜äº®
        ['water', 'fire', 'wind', 'earth'].forEach(t => {
            document.getElementById(t).innerText = this.state[t];
            document.getElementById('r-'+t).classList.toggle('active-rate', s.rates[t] >= 3);
        });

        // æ¸²æŸ“åˆ—è¡¨
        this.renderCards();
        localStorage.setItem('seasons_99_save', JSON.stringify(this.state));
    },

    roll() {
        const btn = document.getElementById('roll-btn');
        const diceEl = document.getElementById('dice-result');
        btn.disabled = true;
        diceEl.classList.add('rolling');

        setTimeout(() => {
            const sIdx = Math.floor(this.state.month / 3);
            const pool = this.seasons[sIdx].dice;
            const res = pool[Math.floor(Math.random()*pool.length)];
            
            diceEl.innerText = res;
            diceEl.classList.remove('rolling');

            // è™•ç†çµæœ
            if(res === 'ğŸ’§') this.state.water++;
            if(res === 'ğŸ”¥') this.state.fire++;
            if(res === 'ğŸƒ') this.state.wind++;
            if(res === 'ğŸª¨') this.state.earth++;
            if(res === 'â­') this.state.summonMax++;
            if(res === 'ğŸ’') this.state.crystals += 3;

            this.state.month++;
            if(this.state.month >= 12) {
                this.state.month = 0;
                this.state.year++;
                if(this.state.year > 3) return this.endGame();
            }
            
            this.triggerPassive('newMonth');
            this.updateUI();
            btn.disabled = false;
        }, 600);
    },

    transmute(type) {
        const sIdx = Math.floor(this.state.month / 3);
        const rate = this.seasons[sIdx].rates[type];
        if (this.state[type] > 0) {
            this.state[type]--;
            this.state.crystals += rate;
            this.triggerPassive('transmute');
            this.updateUI();
        }
    },

    summon(uuid) {
        const hand = this.state.hand[this.state.year-1];
        const idx = hand.findIndex(c => c.uuid === uuid);
        const card = hand[idx];

        if(this.state.currentSummon >= this.state.summonMax) return alert("å¬å–šä¸Šé™ä¸è¶³ï¼");
        
        // æª¢æŸ¥è³‡æº
        for(let r in card.cost) {
            if(this.state[r] < card.cost[r]) return alert("è³‡æºä¸è¶³ï¼");
        }
        
        // æ‰£è²»èˆ‡é€²å ´
        for(let r in card.cost) this.state[r] -= card.cost[r];
        this.state.currentSummon++;
        this.state.field.push(card);
        hand.splice(idx, 1);
        
        if(card.type === 'instant') card.action();
        this.updateUI();
    },

    triggerPassive(type) {
        this.state.field.forEach(c => {
            if(c.type === 'passive' && c.trigger === type) c.action();
        });
    },

    renderCards() {
        const hList = document.getElementById('hand-list');
        const fList = document.getElementById('field-list');
        const currentHand = this.state.hand[this.state.year-1];

        hList.innerHTML = currentHand.map(c => `
            <div class="card ${c.type==='passive'?'passive':''}" onclick="game.summon(${c.uuid})">
                <div style="font-size:1.5rem; text-align:center;">${c.icon}</div>
                <b>${c.name}</b>
                <div class="card-cost">æˆæœ¬: ${JSON.stringify(c.cost)}</div>
                <div style="font-size:0.6rem; color:#9c27b0;">${c.type==='passive'?'è¢«å‹•æ•ˆæœ':'å…¥å ´å³ç™¼'}</div>
            </div>
        `).join('');

        fList.innerHTML = this.state.field.map(c => `
            <div class="card on-field ${c.type==='passive'?'passive':''}">
                <div style="font-size:1.5rem; text-align:center;">${c.icon}</div>
                <b>${c.name}</b>
                <div style="font-size:0.6rem; margin-top:10px; color:#2ecc71;">ä½œç”¨ä¸­</div>
            </div>
        `).join('');
    },

    endGame() {
        const overlay = document.getElementById('end-screen');
        const cScore = this.state.crystals;
        const vScore = this.state.field.reduce((acc, c) => acc + c.vp, 0);
        const pScore = (this.state.hand[0].length + this.state.hand[1].length + this.state.hand[2].length) * -5;

        document.getElementById('s-crystal').innerText = cScore;
        document.getElementById('s-cards').innerText = vScore;
        document.getElementById('s-pen').innerText = pScore;
        document.getElementById('s-total').innerText = cScore + vScore + pScore;

        overlay.style.display = 'flex';
        localStorage.removeItem('seasons_99_save');
    }
};

window.onload = () => game.init();
</script>
</body>
</html>
